<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <title>Nh·∫≠t K√Ω ƒÇn U·ªëng - AI Advisor</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">üçé AI Food Advisor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">üè† Trang Ch·ªß</a></li>
                    <li class="nav-item login-required"><a class="nav-link" href="/profile">üë§ H·ªì S∆°</a></li>
                    <li class="nav-item login-required"><a class="nav-link" href="/chart">üìä Bi·ªÉu ƒê·ªì</a></li>
                    <li class="nav-item login-required"><a class="nav-link active fw-bold" href="/log">üìù Nh·∫≠t K√Ω</a></li>
                    <li class="nav-item" id="auth-nav-item"><a class="nav-link" href="/auth" id="auth-link">üîê ƒêƒÉng Nh·∫≠p/ƒêƒÉng K√Ω</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h1 class="mb-4 text-center text-white fw-bold fade-in">üìù Nh·∫≠t K√Ω ƒÇn U·ªëng</h1>
        
        <div class="row g-4">
            <!-- L·ªãch -->
            <div class="col-lg-4">
                <div class="card animated-card">
                    <div class="card-header gradient-food text-white">
                        <h4 class="mb-0 fw-bold">üìÖ L·ªãch ƒÇn U·ªëng</h4>
                    </div>
                    <div class="card-body">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="calendar-nav-btn" id="prev-month">‚Äπ</button>
                                <h5 class="mb-0" id="current-month">Th√°ng 11, 2025</h5>
                                <button class="calendar-nav-btn" id="next-month">‚Ä∫</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- Calendar s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
                            </div>
                        </div>
                        
                        <!-- N√∫t th√™m m√≥n ƒÉn -->
                        <div class="mt-4">
                            <button class="btn btn-success w-100 fw-bold py-2" data-bs-toggle="modal" data-bs-target="#addMealModal">
                                ‚ûï Th√™m M√≥n ƒÇn
                            </button>
                        </div>

                        <!-- Th·ªëng k√™ nhanh -->
                        <div class="mt-4">
                            <div class="nutrition-fact">
                                <h6 class="fw-bold">üìä H√¥m Nay</h6>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="fw-bold text-primary" id="today-total-calories">0</div>
                                        <small>Calories</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="fw-bold text-success" id="today-meal-count">0</div>
                                        <small>B·ªØa ƒÉn</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danh s√°ch m√≥n ƒÉn -->
            <div class="col-lg-8">
                <div class="card animated-card">
                    <div class="card-header gradient-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 fw-bold" id="selected-date-title">üçΩÔ∏è B·ªØa ƒÇn H√¥m Nay</h4>
                        <button class="btn btn-light btn-sm fw-bold" onclick="loadFoodLog()">
                            üîÑ L√†m m·ªõi
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="log-details">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary mb-3"></div>
                                <p class="text-muted">ƒêang t·∫£i nh·∫≠t k√Ω...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal th√™m m√≥n ƒÉn -->
    <div class="modal fade" id="addMealModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header gradient-success text-white">
                    <h5 class="modal-title fw-bold">‚ûï Th√™m M√≥n ƒÇn M·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-meal-form">
                        <div class="mb-3">
                            <label class="form-label fw-bold">üìÖ Ng√†y ƒÉn</label>
                            <input type="date" class="form-control" id="meal-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">üïí Gi·ªù ƒÉn</label>
                            <input type="time" class="form-control" id="meal-time" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">üì∏ ·∫¢nh m√≥n ƒÉn</label>
                            <input type="file" class="form-control" id="meal-photo" accept="image/*" required>
                            <div class="form-text">Ch·ª•p ·∫£nh m√≥n ƒÉn ƒë·ªÉ AI ph√¢n t√≠ch calories t·ª± ƒë·ªông</div>
                        </div>
                        <div class="text-center mb-3">
                            <img id="meal-preview" src="#" alt="Preview" style="max-width: 100%; max-height: 200px; display: none; border-radius: 10px;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="addNewMeal()">
                        <span id="add-meal-text">üîç Ph√¢n t√≠ch & Th√™m</span>
                        <div id="add-meal-spinner" class="loading-spinner d-none"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDate = new Date();
        let selectedDate = new Date().toISOString().split('T')[0];
        let foodLog = [];
        let serverCurrentDate = '';

        // H√†m l·∫•y ng√†y hi·ªán t·∫°i t·ª´ server
        async function getServerCurrentDate() {
            try {
                const response = await fetch('/api/current_date');
                const data = await response.json();
                serverCurrentDate = data.current_date;
                return serverCurrentDate;
            } catch (error) {
                console.error('L·ªói l·∫•y ng√†y t·ª´ server:', error);
                // Fallback to client date
                serverCurrentDate = new Date().toISOString().split('T')[0];
                return serverCurrentDate;
            }
        }

        async function updateNavbar() {
            const res = await fetch('/api/status');
            const status = await res.json();
            const authLink = document.getElementById('auth-link');
            
            document.querySelectorAll('.login-required').forEach(item => {
                item.style.display = status.logged_in ? 'block' : 'none';
            });

            if (status.logged_in) {
                authLink.textContent = 'üö™ ƒêƒÉng Xu·∫•t (' + status.username + ')';
                authLink.href = '/api/logout';
            } else {
                authLink.textContent = 'üîê ƒêƒÉng Nh·∫≠p/ƒêƒÉng K√Ω';
                authLink.href = '/auth';
            }
            return status;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // L·∫•y ng√†y t·ª´ server ƒë·∫ßu ti√™n
            await getServerCurrentDate();
            await updateNavbar();
            initializeCalendar();
            loadFoodLog();
            
            // Th√™m s·ª± ki·ªán khi modal ƒë∆∞·ª£c m·ªü
            const addMealModal = document.getElementById('addMealModal');
            if (addMealModal) {
                addMealModal.addEventListener('show.bs.modal', function() {
                    // Khi modal m·ªü, c·∫≠p nh·∫≠t ng√†y th√†nh ng√†y ƒëang ch·ªçn
                    updateMealFormDate();
                });
            }
        });

        function initializeCalendar() {
            // S·ª¨A: D√πng serverCurrentDate l√†m ng√†y m·∫∑c ƒë·ªãnh
            selectedDate = serverCurrentDate;
            
            updateCalendar();
            
            // S·ª± ki·ªán n√∫t chuy·ªÉn th√°ng
            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
            });

            // Preview ·∫£nh
            document.getElementById('meal-photo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('meal-preview');
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });

            // Set ng√†y m·∫∑c ƒë·ªãnh - S·ª¨A: lu√¥n d√πng selectedDate
            updateMealFormDate();
        }

        // H√†m c·∫≠p nh·∫≠t ng√†y trong form th√™m m√≥n ƒÉn
        function updateMealFormDate() {
            document.getElementById('meal-date').value = selectedDate;
            document.getElementById('meal-time').value = new Date().toTimeString().substring(0, 5);
        }

        function updateCalendar() {
            const monthNames = ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6",
                              "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"];
            
            document.getElementById('current-month').textContent = 
                `${monthNames[currentDate.getMonth()]}, ${currentDate.getFullYear()}`;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Ng√†y ƒë·∫ßu ti√™n c·ªßa th√°ng
            const firstDay = new Date(year, month, 1);
            // Ng√†y cu·ªëi c√πng c·ªßa th√°ng
            const lastDay = new Date(year, month + 1, 0);
            // Ng√†y b·∫Øt ƒë·∫ßu (th·ª© 2 = 1, Ch·ªß nh·∫≠t = 0)
            const startingDay = firstDay.getDay();
            // ƒêi·ªÅu ch·ªânh ƒë·ªÉ th·ª© 2 l√† ng√†y ƒë·∫ßu tu·∫ßn
            const adjustedStart = startingDay === 0 ? 6 : startingDay - 1;
            const daysInMonth = lastDay.getDate();
            
            const grid = document.getElementById('calendar-grid');
            let calendarHTML = '';
            
            // Th√™m header - 7 ng√†y trong tu·∫ßn
            const daysOfWeek = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
            daysOfWeek.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            let dayCount = 1;
            
            // T·∫°o 6 h√†ng (6 tu·∫ßn) - t·ªïng 42 √¥
            for (let week = 0; week < 6; week++) {
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    const cellIndex = week * 7 + dayOfWeek;
                    
                    if (cellIndex < adjustedStart || dayCount > daysInMonth) {
                        // √î tr·ªëng (tr∆∞·ªõc ng√†y ƒë·∫ßu th√°ng ho·∫∑c sau ng√†y cu·ªëi th√°ng)
                        calendarHTML += `<div class="calendar-day other-month"></div>`;
                    } else {
                        // Ng√†y trong th√°ng
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayCount).padStart(2, '0')}`;
                        const hasMeals = foodLog.some(meal => meal.date === dateStr);
                        const isSelected = dateStr === selectedDate;
                        // S·ª¨A: D√πng serverCurrentDate ƒë·ªÉ x√°c ƒë·ªãnh ng√†y h√¥m nay
                        const isToday = dateStr === serverCurrentDate;
                        
                        let dayClass = 'calendar-day';
                        if (isSelected) dayClass += ' active';
                        if (hasMeals) dayClass += ' has-meals';
                        if (isToday) dayClass += ' today';
                        
                        calendarHTML += `<div class="${dayClass}" data-date="${dateStr}">${dayCount}</div>`;
                        dayCount++;
                    }
                }
            }
            
            grid.innerHTML = calendarHTML;
            
            // Th√™m s·ª± ki·ªán click cho c√°c ng√†y
            document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                day.addEventListener('click', function() {
                    selectedDate = this.dataset.date;
                    updateCalendar();
                    loadFoodLog();
                    // QUAN TR·ªåNG: C·∫≠p nh·∫≠t ng√†y trong form khi ch·ªçn ng√†y m·ªõi
                    updateMealFormDate();
                });
            });
        }

        async function loadFoodLog() {
            try {
                const res = await fetch('/api/food_log');
                if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i nh·∫≠t k√Ω');
                
                foodLog = await res.json();
                displayFoodLog();
                updateCalendar();
                updateTodayStats();
                
            } catch (error) {
                console.error('L·ªói load food log:', error);
                document.getElementById('log-details').innerHTML = `
                    <div class="alert alert-danger text-center">
                        ‚ùå L·ªói t·∫£i nh·∫≠t k√Ω: ${error.message}
                    </div>
                `;
            }
        }

        function displayFoodLog() {
            const selectedLog = foodLog.filter(meal => meal.date === selectedDate);
            const logDiv = document.getElementById('log-details');
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ - S·ª¨A: d√πng serverCurrentDate
            const dateObj = new Date(selectedDate);
            const today = serverCurrentDate;
            const title = selectedDate === today ? 'üçΩÔ∏è B·ªØa ƒÇn H√¥m Nay' : 
                         `üçΩÔ∏è B·ªØa ƒÇn Ng√†y ${dateObj.toLocaleDateString('vi-VN')}`;
            document.getElementById('selected-date-title').textContent = title;
            
            if (selectedLog.length === 0) {
                logDiv.innerHTML = `
                    <div class="alert alert-warning text-center animated-card">
                        <h5>üçÉ Ch∆∞a c√≥ b·ªØa ƒÉn n√†o!</h5>
                        <p class="mb-3">H√£y th√™m m√≥n ƒÉn ƒë·∫ßu ti√™n cho ng√†y n√†y.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMealModal">
                            ‚ûï Th√™m M√≥n ƒÇn
                        </button>
                    </div>
                `;
                return;
            }

            // Nh√≥m theo b·ªØa ƒÉn d·ª±a tr√™n th·ªùi gian
            const mealsByTime = {
                'S√°ng': [],
                'Tr∆∞a': [],
                'T·ªëi': [],
                'Ph·ª•': []
            };

            selectedLog.forEach(meal => {
                const mealTime = meal.timestamp ? new Date(meal.timestamp).getHours() : 12;
                let timeCategory = 'Ph·ª•';
                
                if (mealTime >= 5 && mealTime < 11) timeCategory = 'S√°ng';
                else if (mealTime >= 11 && mealTime < 14) timeCategory = 'Tr∆∞a';
                else if (mealTime >= 17 && mealTime < 22) timeCategory = 'T·ªëi';
                
                mealsByTime[timeCategory].push(meal);
            });

            let html = '';
            const totalCalories = selectedLog.reduce((sum, meal) => sum + (meal.calories || 0), 0);

            // Hi·ªÉn th·ªã t·ªïng calories
            html += `
                <div class="alert gradient-info text-white text-center mb-4">
                    <h6 class="mb-1">üìä T·ªïng Calories</h6>
                    <div class="fw-bold fs-3">${totalCalories} kcal</div>
                </div>
            `;

            // Hi·ªÉn th·ªã t·ª´ng b·ªØa ƒÉn
            for (const [timeCategory, meals] of Object.entries(mealsByTime)) {
                if (meals.length > 0) {
                    html += `<h6 class="mt-4 mb-3 text-primary">üïí ${timeCategory}</h6>`;
                    
                    meals.forEach(meal => {
                        const time = meal.timestamp ? 
                            new Date(meal.timestamp).toLocaleTimeString('vi-VN', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            }) : '--:--';
                        
                        html += `
                            <div class="card meal-card mb-3 fade-in">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title text-primary mb-1">${meal.meal_name}</h6>
                                            <p class="card-text text-muted small mb-2">${meal.description}</p>
                                            <div class="d-flex gap-2 align-items-center">
                                                <span class="badge calorie-badge gradient-warning text-dark">
                                                    üî• ${meal.calories} kcal
                                                </span>
                                                <small class="text-muted">‚è∞ ${time}</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm delete-meal" 
                                                data-timestamp="${meal.timestamp}" 
                                                title="X√≥a b·ªØa ƒÉn">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            }

            logDiv.innerHTML = html;

            // Th√™m s·ª± ki·ªán x√≥a
            document.querySelectorAll('.delete-meal').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const timestamp = this.dataset.timestamp;
                    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªØa ƒÉn n√†y?')) {
                        await deleteMeal(timestamp);
                    }
                });
            });
        }

        function updateTodayStats() {
            // S·ª¨A: D√πng serverCurrentDate
            const today = serverCurrentDate;
            const todayLog = foodLog.filter(meal => meal.date === today);
            const todayCalories = todayLog.reduce((sum, meal) => sum + (meal.calories || 0), 0);
            
            document.getElementById('today-total-calories').textContent = todayCalories;
            document.getElementById('today-meal-count').textContent = todayLog.length;
        }

        async function addNewMeal() {
            const mealDate = document.getElementById('meal-date').value;
            const mealTime = document.getElementById('meal-time').value;
            const photoInput = document.getElementById('meal-photo');
            
            if (!photoInput.files.length) {
                alert('üì∏ Vui l√≤ng ch·ªçn ·∫£nh m√≥n ƒÉn!');
                return;
            }

            const addText = document.getElementById('add-meal-text');
            const addSpinner = document.getElementById('add-meal-spinner');
            
            addText.textContent = 'ƒêang ph√¢n t√≠ch...';
            addSpinner.classList.remove('d-none');

            try {
                const formData = new FormData();
                formData.append('photo', photoInput.files[0]);
                formData.append('date', mealDate);
                formData.append('time', mealTime);

                const response = await fetch('/api/log_meal', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // ƒê√≥ng modal v√† reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addMealModal'));
                    modal.hide();
                    document.getElementById('add-meal-form').reset();
                    document.getElementById('meal-preview').style.display = 'none';
                    
                    // Reload d·ªØ li·ªáu
                    await loadFoodLog();
                    
                    // Th√¥ng b√°o th√†nh c√¥ng
                    alert('‚úÖ ƒê√£ th√™m m√≥n ƒÉn th√†nh c√¥ng!');
                } else {
                    alert('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ th√™m m√≥n ƒÉn'));
                }

            } catch (error) {
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            } finally {
                addText.textContent = 'üîç Ph√¢n t√≠ch & Th√™m';
                addSpinner.classList.add('d-none');
            }
        }

        async function deleteMeal(timestamp) {
            try {
                const response = await fetch('/api/delete_meal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timestamp: timestamp })
                });

                if (response.ok) {
                    await loadFoodLog();
                } else {
                    alert('‚ùå L·ªói khi x√≥a b·ªØa ƒÉn');
                }
            } catch (error) {
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }
    </script>
</body>
</html>