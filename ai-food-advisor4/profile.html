<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <title>Há»“ sÆ¡ cÃ¡ nhÃ¢n - AI Advisor</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark gradient-success">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">ğŸ¥— AI Food Advisor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">ğŸ  Trang Chá»§</a></li>
                    <li class="nav-item login-required"><a class="nav-link active fw-bold" href="/profile">ğŸ‘¤ Há»“ SÆ¡</a></li>
                    <li class="nav-item login-required"><a class="nav-link" href="/chart">ğŸ“Š Biá»ƒu Äá»“</a></li>
                    <li class="nav-item login-required"><a class="nav-link" href="/log">ğŸ“ Nháº­t KÃ½</a></li>
                    <li class="nav-item" id="auth-nav-item"><a class="nav-link" href="/auth" id="auth-link">ğŸ” ÄÄƒng Nháº­p/ÄÄƒng KÃ½</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h1 class="mb-4 text-center text-white fw-bold fade-in">ğŸ‘¤ Quáº£n lÃ½ Há»“ sÆ¡ CÃ¡ nhÃ¢n</h1>
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card animated-card shadow">
                    <div class="card-header gradient-primary text-white">
                        <h4 class="mb-0 fw-bold">ğŸ“Š ThÃ´ng tin cÃ¡ nhÃ¢n</h4>
                    </div>
                    <div class="card-body">
                        <div id="profile-instruction" class="alert alert-info text-center">
                            Äang táº£i tráº¡ng thÃ¡i Há»“ sÆ¡...
                        </div>
                        
                        <form id="profile-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ğŸ‘¤ TÃªn Ä‘áº§y Ä‘á»§</label>
                                    <input type="text" id="name" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">âš¤ Giá»›i tÃ­nh</label>
                                    <select id="gender" class="form-select" required>
                                        <option value="">Chá»n giá»›i tÃ­nh...</option>
                                        <option value="nam">Nam</option>
                                        <option value="ná»¯">Ná»¯</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">ğŸ‚ Tuá»•i</label>
                                    <input type="number" id="age" class="form-control" min="1" max="120" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">ğŸ“ Chiá»u cao (cm)</label>
                                    <input type="number" id="height_cm" class="form-control" min="50" max="250" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">âš–ï¸ CÃ¢n náº·ng (kg)</label>
                                    <input type="number" id="weight_kg" class="form-control" min="20" max="300" required>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ğŸ¯ Má»¥c tiÃªu cÃ¡ nhÃ¢n</label>
                                    <select id="goal" class="form-select" required>
                                        <option value="">Chá»n má»¥c tiÃªu...</option>
                                        <option value="giá»¯ cÃ¢n">ğŸ”„ Giá»¯ cÃ¢n</option>
                                        <option value="giáº£m cÃ¢n">â¬‡ï¸ Giáº£m cÃ¢n</option>
                                        <option value="tÄƒng cÃ¢n">â¬†ï¸ TÄƒng cÃ¢n</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">ğŸƒ Má»©c Ä‘á»™ hoáº¡t Ä‘á»™ng</label>
                                    <select id="activity_level" class="form-select" required>
                                        <option value="">Chá»n má»©c Ä‘á»™...</option>
                                        <option value="Ã­t">ğŸ›‹ï¸ Ãt (Ãt váº­n Ä‘á»™ng)</option>
                                        <option value="bÃ¬nh thÆ°á»ng">ğŸš¶ BÃ¬nh thÆ°á»ng</option>
                                        <option value="nhiá»u">ğŸƒ Nhiá»u (Táº­p luyá»‡n hÃ ng ngÃ y)</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success w-100 mt-4 fw-bold py-2">
                                ğŸ’¾ LÆ°u & Cáº­p nháº­t Há»“ sÆ¡
                            </button>
                            <div id="profile-status" class="mt-3 text-center fw-bold"></div>
                        </form>
                        
                        <div id="profile-info" class="mt-4 border-top pt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function updateNavbar() {
            const res = await fetch('/api/status');
            const status = await res.json();
            const authLink = document.getElementById('auth-link');
            
            document.querySelectorAll('.login-required').forEach(item => {
                item.style.display = status.logged_in ? 'block' : 'none';
            });

            if (status.logged_in) {
                authLink.textContent = 'ğŸšª ÄÄƒng Xuáº¥t (' + status.username + ')';
                authLink.href = '/api/logout';
            } else {
                authLink.textContent = 'ğŸ” ÄÄƒng Nháº­p/ÄÄƒng KÃ½';
                authLink.href = '/auth';
            }
            return status;
        }

        document.addEventListener('DOMContentLoaded', updateNavbar);
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', loadProfile);

        async function loadProfile() {
            const status = await updateNavbar();
            if (!status.logged_in) return; 

            const res = await fetch('/api/profile');
            const data = await res.json();
            const inst = document.getElementById('profile-instruction');

            if (res.ok && data) {
                inst.className = 'alert alert-success text-center animated-card';
                inst.innerHTML = `ğŸ‰ <strong>ChÃ o má»«ng, ${data.name}!</strong> Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c lÆ°u. Báº¡n cÃ³ muá»‘n chá»‰nh sá»­a khÃ´ng?`;
                displayProfile(data);
                // Äiá»n dá»¯ liá»‡u vÃ o form
                for (const key in data) {
                    const input = document.getElementById(key);
                    if (input) input.value = data[key];
                }
            } else {
                inst.className = 'alert alert-warning text-center animated-card';
                inst.innerHTML = `ğŸ‘‹ <strong>ChÃ o ${status.username}!</strong> Vui lÃ²ng nháº­p Há»“ sÆ¡ cÃ¡ nhÃ¢n cá»§a báº¡n láº§n Ä‘áº§u tiÃªn!`;
            }
        }

        function displayProfile(profile) {
            const infoDiv = document.getElementById('profile-info');
            infoDiv.innerHTML = `
                <div class="fade-in">
                    <h4 class="text-primary mb-3">ğŸ“ˆ Káº¿t quáº£ tÃ­nh toÃ¡n dinh dÆ°á»¡ng</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card bg-light animated-card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">ğŸ¯ Má»¥c tiÃªu</h6>
                                    <p class="fs-5 fw-bold text-success">${profile.goal.toUpperCase()}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light animated-card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">ğŸ”¥ Calories Má»¥c tiÃªu</h6>
                                    <p class="fs-5 fw-bold text-danger">${profile.target_calories} kcal</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light animated-card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">âš¡ TDEE (Nhu cáº§u)</h6>
                                    <p class="fs-5 fw-bold text-primary">${profile.tdee} kcal</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light animated-card">
                                <div class="card-body text-center">
                                    <h6 class="card-title">ğŸƒ Hoáº¡t Ä‘á»™ng</h6>
                                    <p class="fs-5 fw-bold text-info">${profile.activity_level}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.name.value, 
                gender: form.gender.value, 
                age: parseInt(form.age.value) || 0, 
                height_cm: parseFloat(form.height_cm.value) || 0, 
                weight_kg: parseFloat(form.weight_kg.value) || 0, 
                goal: form.goal.value, 
                activity_level: form.activity_level.value,
            };

            const statusP = document.getElementById('profile-status');
            const response = await fetch('/api/profile', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(data),
            });
            const result = await response.json();
            
            if (response.ok) {
                statusP.className = 'text-success fw-bold';
                statusP.innerHTML = `âœ… ${result.message} (Má»¥c tiÃªu: <span class="text-danger">${result.profile.target_calories} kcal</span>)`;
                displayProfile(result.profile);
                updateNavbar();
            } else {
                statusP.className = 'text-danger fw-bold';
                statusP.textContent = 'âŒ Lá»—i: ' + result.error;
            }
        });
    </script>
</body>
</html>