<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Bi·ªÉu ƒê·ªì Dinh D∆∞·ª°ng - AI Advisor</title>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">üçé AI Food Advisor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">üè† Trang Ch·ªß</a></li>
                    <li class="nav-item login-required"><a class="nav-link" href="/profile">üë§ H·ªì S∆°</a></li>
                    <li class="nav-item login-required"><a class="nav-link active fw-bold" href="/chart">üìä Bi·ªÉu ƒê·ªì</a></li>
                    <li class="nav-item login-required"><a class="nav-link" href="/log">üìù Nh·∫≠t K√Ω</a></li>
                    <li class="nav-item" id="auth-nav-item"><a class="nav-link" href="/auth" id="auth-link">üîê ƒêƒÉng Nh·∫≠p/ƒêƒÉng K√Ω</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <h1 class="mb-4 text-center text-white fw-bold fade-in">üìä Ph√¢n T√≠ch Dinh D∆∞·ª°ng</h1>
        
        <div class="row g-4">
            <!-- Bi·ªÉu ƒë·ªì calories theo ng√†y -->
            <div class="col-12">
                <div class="card animated-card">
                    <div class="card-header gradient-food text-white">
                        <h4 class="mb-0 fw-bold">üìà Calories Theo Ng√†y</h4>
                    </div>
                    <div class="card-body">
                        <div class="period-selector">
                            <button class="period-btn active" data-period="7">7 Ng√†y</button>
                            <button class="period-btn" data-period="14">14 Ng√†y</button>
                            <button class="period-btn" data-period="30">30 Ng√†y</button>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="caloriesChart"></canvas>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <div class="nutrition-fact">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="text-primary fw-bold fs-4" id="avg-calories">0</div>
                                        <small>Trung b√¨nh/ng√†y</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-success fw-bold fs-4" id="max-calories">0</div>
                                        <small>Cao nh·∫•t</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-warning fw-bold fs-4" id="min-calories">0</div>
                                        <small>Th·∫•p nh·∫•t</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì so s√°nh m·ª•c ti√™u -->
            <div class="col-md-6">
                <div class="card animated-card h-100">
                    <div class="card-header gradient-primary text-white">
                        <h4 class="mb-0 fw-bold">üéØ Ti·∫øn ƒê·ªô M·ª•c Ti√™u</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="targetChart"></canvas>
                        </div>
                        <div class="text-center mt-3">
                            <div class="fw-bold fs-3" id="target-achievement">0%</div>
                            <small>ƒê·∫°t m·ª•c ti√™u</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Th·ªëng k√™ t·ªïng quan -->
            <div class="col-md-6">
                <div class="card animated-card h-100">
                    <div class="card-header gradient-success text-white">
                        <h4 class="mb-0 fw-bold">üìä T·ªïng Quan</h4>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="food-icon">üî•</div>
                                <div class="stat-label">Calories H√¥m Nay</div>
                                <div class="stat-value" id="today-calories">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="food-icon">üéØ</div>
                                <div class="stat-label">M·ª•c Ti√™u</div>
                                <div class="stat-value" id="target-calories">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="food-icon">‚ö°</div>
                                <div class="stat-label">C√≤n L·∫°i</div>
                                <div class="stat-value" id="remaining-calories">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="food-icon">üìÖ</div>
                                <div class="stat-label">T·ªïng B·ªØa ƒÇn</div>
                                <div class="stat-value" id="total-meals">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì lo·∫°i m√≥n ƒÉn -->
            <div class="col-12">
                <div class="card animated-card">
                    <div class="card-header gradient-warning text-white">
                        <h4 class="mb-0 fw-bold">üçΩÔ∏è Ph√¢n B·ªï C√°c B·ªØa</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="mealTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- G·ª£i √Ω th√¥ng minh -->
            <div class="col-12">
                <div class="card animated-card">
                    <div class="card-header gradient-info text-white">
                        <h4 class="mb-0 fw-bold">üí° Ph√¢n T√≠ch & G·ª£i √Ω</h4>
                    </div>
                    <div class="card-body">
                        <div id="analysis-content">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2 text-muted">ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let serverCurrentDate = '';

        // H√†m l·∫•y ng√†y hi·ªán t·∫°i t·ª´ server
        async function getServerCurrentDate() {
            try {
                const response = await fetch('/api/current_date');
                const data = await response.json();
                serverCurrentDate = data.current_date;
                return serverCurrentDate;
            } catch (error) {
                console.error('L·ªói l·∫•y ng√†y t·ª´ server:', error);
                // Fallback to client date
                serverCurrentDate = new Date().toISOString().split('T')[0];
                return serverCurrentDate;
            }
        }

        async function updateNavbar() {
            const res = await fetch('/api/status');
            const status = await res.json();
            const authLink = document.getElementById('auth-link');
            
            document.querySelectorAll('.login-required').forEach(item => {
                item.style.display = status.logged_in ? 'block' : 'none';
            });

            if (status.logged_in) {
                authLink.textContent = 'üö™ ƒêƒÉng Xu·∫•t (' + status.username + ')';
                authLink.href = '/api/logout';
            } else {
                authLink.textContent = 'üîê ƒêƒÉng Nh·∫≠p/ƒêƒÉng K√Ω';
                authLink.href = '/auth';
            }
            return status;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // L·∫•y ng√†y t·ª´ server ƒë·∫ßu ti√™n
            await getServerCurrentDate();
            await updateNavbar();
            initializeCharts();
        });

        let caloriesChart, targetChart, mealTypeChart;
        let currentPeriod = 7;

        function initializeCharts() {
            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì calories
            const caloriesCtx = document.getElementById('caloriesChart').getContext('2d');
            caloriesChart = new Chart(caloriesCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Calories Ti√™u Th·ª•',
                        data: [],
                        backgroundColor: '#4ecdc4',
                        borderColor: '#44a08d',
                        borderWidth: 2
                    }, {
                        label: 'M·ª•c Ti√™u',
                        data: [],
                        type: 'line',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} kcal`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Calories (kcal)'
                            }
                        }
                    }
                }
            });

            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì m·ª•c ti√™u
            const targetCtx = document.getElementById('targetChart').getContext('2d');
            targetChart = new Chart(targetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ƒê·∫°t M·ª•c Ti√™u', 'Ch∆∞a ƒê·∫°t'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#4ecdc4', '#f8f9fa'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì lo·∫°i m√≥n ƒÉn
            const mealTypeCtx = document.getElementById('mealTypeChart').getContext('2d');
            mealTypeChart = new Chart(mealTypeCtx, {
                type: 'pie',
                data: {
                    labels: ['S√°ng', 'Tr∆∞a', 'T·ªëi', 'Ph·ª•'],
                    datasets: [{
                        data: [25, 35, 30, 10],
                        backgroundColor: ['#4facfe', '#f5576c', '#f093fb', '#4ecdc4'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // S·ª± ki·ªán ch·ªçn kho·∫£ng th·ªùi gian
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = parseInt(this.dataset.period);
                    loadChartData();
                });
            });

            // Load d·ªØ li·ªáu ban ƒë·∫ßu
            loadChartData();
        }

        async function loadChartData() {
            try {
                const [logRes, profileRes] = await Promise.all([
                    fetch('/api/food_log'),
                    fetch('/api/profile')
                ]);

                if (!logRes.ok || !profileRes.ok) {
                    throw new Error('Kh√¥ng th·ªÉ load d·ªØ li·ªáu');
                }

                const foodLog = await logRes.json();
                const profile = await profileRes.json();

                if (!profile) {
                    showError('Vui l√≤ng c·∫≠p nh·∫≠t h·ªì s∆° ƒë·ªÉ xem ph√¢n t√≠ch');
                    return;
                }

                // Ph√¢n t√≠ch d·ªØ li·ªáu th·ª±c t·∫ø - S·ª¨A: D√πng serverCurrentDate
                const analysis = analyzeRealData(foodLog, profile, currentPeriod);
                
                // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
                updateCharts(analysis, profile);
                updateStats(analysis, profile);
                updateAnalysisContent(analysis, profile);

            } catch (error) {
                console.error('L·ªói load chart data:', error);
                showError('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message);
            }
        }

        function analyzeRealData(foodLog, profile, days) {
            // S·ª¨A: D√πng serverCurrentDate l√†m ng√†y hi·ªán t·∫°i
            const now = new Date(serverCurrentDate);
            const startDate = new Date(now.getTime() - (days - 1) * 24 * 60 * 60 * 1000);
            
            // L·ªçc d·ªØ li·ªáu theo kho·∫£ng th·ªùi gian
            const filteredLog = foodLog.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= startDate && itemDate <= now;
            });

            // Nh√≥m theo ng√†y
            const dailyData = {};
            const dateLabels = [];
            const caloriesData = [];
            const targetData = [];
            
            // T·∫°o d·ªØ li·ªáu cho m·ªói ng√†y
            for (let i = 0; i < days; i++) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                const dateStr = date.toISOString().split('T')[0];
                dateLabels.unshift(formatDate(date));
                
                const dayLog = filteredLog.filter(item => item.date === dateStr);
                const dayCalories = dayLog.reduce((sum, item) => sum + (item.calories || 0), 0);
                
                caloriesData.unshift(dayCalories);
                targetData.unshift(profile.target_calories);
                
                dailyData[dateStr] = {
                    calories: dayCalories,
                    meals: dayLog,
                    date: dateStr
                };
            }

            // T√≠nh to√°n th·ªëng k√™
            const validCalories = caloriesData.filter(cal => cal > 0);
            const avgCalories = validCalories.length > 0 ? 
                Math.round(validCalories.reduce((a, b) => a + b, 0) / validCalories.length) : 0;
            const maxCalories = validCalories.length > 0 ? Math.max(...validCalories) : 0;
            const minCalories = validCalories.length > 0 ? Math.min(...validCalories) : 0;

            // Ph√¢n lo·∫°i m√≥n ƒÉn
            const mealTypes = analyzeMealTypes(filteredLog);

            // T√≠nh % ƒë·∫°t m·ª•c ti√™u
            const targetDays = caloriesData.filter(cal => cal <= profile.target_calories && cal > 0).length;
            const totalDays = validCalories.length;
            const achievementRate = totalDays > 0 ? Math.round((targetDays / totalDays) * 100) : 0;

            return {
                dailyData,
                dateLabels,
                caloriesData,
                targetData,
                avgCalories,
                maxCalories,
                minCalories,
                mealTypes,
                achievementRate,
                totalMeals: filteredLog.length,
                // S·ª¨A: D√πng serverCurrentDate ƒë·ªÉ l·∫•y calories h√¥m nay
                todayCalories: dailyData[serverCurrentDate]?.calories || 0
            };
        }

        function analyzeMealTypes(foodLog) {
            const types = { 'S√°ng': 0, 'Tr∆∞a': 0, 'T·ªëi': 0, 'Ph·ª•': 0 };
            
            foodLog.forEach(meal => {
                const mealName = meal.meal_name.toLowerCase();
                const mealTime = meal.timestamp ? new Date(meal.timestamp).getHours() : 12;
                
                if (mealTime >= 5 && mealTime < 11) types['S√°ng']++;
                else if (mealTime >= 11 && mealTime < 14) types['Tr∆∞a']++;
                else if (mealTime >= 17 && mealTime < 22) types['T·ªëi']++;
                else types['Ph·ª•']++;
            });

            return types;
        }

        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', { 
                day: '2-digit', 
                month: '2-digit' 
            });
        }

        function updateCharts(analysis, profile) {
            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì calories
            caloriesChart.data.labels = analysis.dateLabels;
            caloriesChart.data.datasets[0].data = analysis.caloriesData;
            caloriesChart.data.datasets[1].data = analysis.targetData;
            caloriesChart.update();

            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì m·ª•c ti√™u
            targetChart.data.datasets[0].data = [
                analysis.achievementRate,
                100 - analysis.achievementRate
            ];
            targetChart.update();

            // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì lo·∫°i m√≥n ƒÉn
            mealTypeChart.data.datasets[0].data = [
                analysis.mealTypes['S√°ng'],
                analysis.mealTypes['Tr∆∞a'],
                analysis.mealTypes['T·ªëi'],
                analysis.mealTypes['Ph·ª•']
            ];
            mealTypeChart.update();

            // C·∫≠p nh·∫≠t th·ªëng k√™
            document.getElementById('avg-calories').textContent = analysis.avgCalories;
            document.getElementById('max-calories').textContent = analysis.maxCalories;
            document.getElementById('min-calories').textContent = analysis.minCalories;
            document.getElementById('target-achievement').textContent = analysis.achievementRate + '%';
        }

        function updateStats(analysis, profile) {
            const remaining = profile.target_calories - analysis.todayCalories;
            
            document.getElementById('today-calories').textContent = analysis.todayCalories;
            document.getElementById('target-calories').textContent = profile.target_calories;
            document.getElementById('remaining-calories').textContent = remaining;
            document.getElementById('total-meals').textContent = analysis.totalMeals;

            // ƒê·ªïi m√†u remaining calories
            const remainingElement = document.getElementById('remaining-calories');
            remainingElement.className = 'stat-value ' + 
                (remaining < 0 ? 'text-danger' : 
                 remaining > 500 ? 'text-info' : 'text-warning');
        }

        function updateAnalysisContent(analysis, profile) {
            let content = '';
            const goal = profile.goal;
            const todayRemaining = profile.target_calories - analysis.todayCalories;

            // Ph√¢n t√≠ch t·ªïng quan
            content += `<div class="alert alert-info">
                <h6>üìä T·ªïng Quan ${currentPeriod} Ng√†y Qua</h6>
                <p>B·∫°n ƒë√£ ƒÉn trung b√¨nh <strong>${analysis.avgCalories} kcal/ng√†y</strong>, 
                ${analysis.achievementRate}% ng√†y ƒë·∫°t m·ª•c ti√™u.</p>
            </div>`;

            // Ph√¢n t√≠ch theo m·ª•c ti√™u
            if (goal === 'gi·∫£m c√¢n') {
                if (analysis.avgCalories > profile.target_calories + 200) {
                    content += `<div class="alert alert-warning">
                        <h6>‚ö†Ô∏è C·∫ßn Ch√∫ √ù</h6>
                        <p>L∆∞·ª£ng calories trung b√¨nh cao h∆°n m·ª•c ti√™u. Th·ª≠ gi·∫£m kh·∫©u ph·∫ßn tinh b·ªôt v√† tƒÉng c∆∞·ªùng rau xanh.</p>
                    </div>`;
                } else if (analysis.avgCalories <= profile.target_calories) {
                    content += `<div class="alert alert-success">
                        <h6>üéâ Xu·∫•t S·∫Øc!</h6>
                        <p>B·∫°n ƒëang ki·ªÉm so√°t calories r·∫•t t·ªët! Ti·∫øp t·ª•c duy tr√¨ ƒë·ªÉ ƒë·∫°t m·ª•c ti√™u gi·∫£m c√¢n.</p>
                    </div>`;
                }
            }

            // Ph√¢n t√≠ch h√¥m nay
            if (todayRemaining < -300) {
                content += `<div class="alert alert-danger">
                    <h6>üçΩÔ∏è H√¥m Nay</h6>
                    <p>B·∫°n ƒë√£ ƒÉn v∆∞·ª£t ${Math.abs(todayRemaining)}kcal. B·ªØa t·ªëi n√™n ch·ªçn m√≥n nh·∫π nh√†ng.</p>
                </div>`;
            } else if (todayRemaining > 0) {
                content += `<div class="alert alert-success">
                    <h6>üçΩÔ∏è H√¥m Nay</h6>
                    <p>C√≤n ${todayRemaining}kcal. B·∫°n c√≥ th·ªÉ ƒÉn th√™m b·ªØa ph·ª• l√†nh m·∫°nh.</p>
                </div>`;
            }

            // G·ª£i √Ω c·∫£i thi·ªán
            if (analysis.mealTypes['Ph·ª•'] === 0 && analysis.totalMeals > 10) {
                content += `<div class="alert alert-info">
                    <h6>üí° M·∫πo Dinh D∆∞·ª°ng</h6>
                    <p>Th·ª≠ th√™m b·ªØa ph·ª• l√†nh m·∫°nh (tr√°i c√¢y, s·ªØa chua) ƒë·ªÉ duy tr√¨ nƒÉng l∆∞·ª£ng ·ªïn ƒë·ªãnh.</p>
                </div>`;
            }

            document.getElementById('analysis-content').innerHTML = content;
        }

        function showError(message) {
            document.getElementById('analysis-content').innerHTML = `
                <div class="alert alert-danger text-center">
                    ‚ùå ${message}
                </div>
            `;
        }
    </script>
</body>
</html>