<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <title>Trang Ch·ªß - AI Food Advisor</title>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark gradient-success sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                ü•ó AI Food Advisor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active fw-bold" href="/">
                            üè† Trang Ch·ªß
                        </a>
                    </li>
                    <li class="nav-item login-required">
                        <a class="nav-link fw-bold" href="/profile">
                            üë§ H·ªì S∆°
                        </a>
                    </li>
                    <li class="nav-item login-required">
                        <a class="nav-link" href="/chart">
                            üìä Bi·ªÉu ƒê·ªì
                        </a>
                    </li>
                    <li class="nav-item login-required">
                        <a class="nav-link fw-bold" href="/log">
                            üìù Nh·∫≠t K√Ω
                        </a>
                    </li>
                    <li class="nav-item" id="auth-nav-item">
                        <a class="nav-link fw-bold" href="/auth" id="auth-link">
                            üîê ƒêƒÉng Nh·∫≠p/ƒêƒÉng K√Ω
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="container my-4">
        <!-- Ti√™u ƒë·ªÅ -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center text-white fw-bold mb-3 fade-in">
                    üçΩÔ∏è Ph√¢n t√≠ch b·ªØa ƒÉn & G·ª£i √Ω th·ª±c ƒë∆°n th√¥ng minh
                </h1>
                <p class="text-center text-light opacity-75">
                    ·ª®ng d·ª•ng AI gi√∫p b·∫°n qu·∫£n l√Ω dinh d∆∞·ª°ng th√¥ng minh
                </p>
            </div>
        </div>

        <div class="row g-4">
            <!-- C·ªôt tr√°i - Ghi nh·∫≠n m√≥n ƒÉn -->
            <div class="col-lg-6">
                <div class="card animated-card h-100">
                    <div class="card-header gradient-warning text-white">
                        <h4 class="mb-0 fw-bold">üì∏ Ghi nh·∫≠n m√≥n ƒÉn c·ªßa b·∫°n</h4>
                    </div>
                    <div class="card-body">
                        <form id="meal-upload-form" class="login-required">
                            <div class="mb-3">
                                <label class="form-label fw-bold text-dark">Ch·ªçn ·∫£nh m√≥n ƒÉn:</label>
                                <input type="file" name="photo" id="meal-photo" 
                                       accept="image/*" class="form-control" required>
                            </div>
                            
                            <!-- Preview ·∫£nh -->
                            <div class="text-center mb-3" id="image-preview-container">
                                <img id="image-preview" src="#" alt="·∫¢nh m√≥n ƒÉn" 
                                     style="max-width: 100%; max-height: 200px; display: none; 
                                            border-radius: 10px; border: 3px solid #ffc107;">
                            </div>
                            
                            <!-- N√∫t ph√¢n t√≠ch -->
                            <button type="submit" class="btn btn-warning w-100 fw-bold py-2">
                                <span id="upload-text">üîç Ph√¢n t√≠ch & Ghi nh·∫≠n</span>
                                <div id="upload-spinner" class="loading-spinner d-none"></div>
                            </button>
                        </form>

                        <!-- K·∫øt qu·∫£ ph√¢n t√≠ch -->
                        <div id="meal-recognition-results" class="mt-4">
                            <div class="alert alert-light text-center border">
                                <h6 class="text-muted mb-2">üìä K·∫øt qu·∫£ ph√¢n t√≠ch</h6>
                                <p class="text-muted mb-0">
                                    ·∫¢nh c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c AI ph√¢n t√≠ch v√† hi·ªÉn th·ªã k·∫øt qu·∫£ t·∫°i ƒë√¢y
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- C·ªôt ph·∫£i - G·ª£i √Ω m√≥n ƒÉn -->
            <div class="col-lg-6">
                <div class="card animated-card h-100">
                    <div class="card-header gradient-primary text-white">
                        <h4 class="mb-0 fw-bold">üí° G·ª£i √Ω m√≥n ƒÉn t·ª´ AI</h4>
                    </div>
                    <div class="card-body">
                        <!-- T·ªïng quan calories -->
                        <div class="mb-4">
                            <div id="calorie-summary" class="card bg-light border-0">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-primary fw-bold mb-3">üìà T·ªïng quan Calories h√¥m nay</h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="text-success fw-bold fs-5" id="target-calories">--</div>
                                            <small class="text-muted">M·ª•c ti√™u</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-danger fw-bold fs-5" id="consumed-calories">--</div>
                                            <small class="text-muted">ƒê√£ ƒÉn</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-info fw-bold fs-5" id="remaining-calories">--</div>
                                            <small class="text-muted">C√≤n l·∫°i</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- N√∫t g·ª£i √Ω -->
                        <button id="suggest-menu-btn" class="btn btn-primary w-100 fw-bold py-2 mb-4">
                            <span id="suggest-text">üéØ G·ª£i √Ω Th·ª±c ƒë∆°n ti·∫øp theo</span>
                            <div id="suggest-spinner" class="loading-spinner d-none"></div>
                        </button>

                        <!-- Khu v·ª±c g·ª£i √Ω -->
                        <div id="menu-suggestions">
                            <div class="alert alert-info text-center border-0">
                                <div class="fs-1 mb-3">üçΩÔ∏è</div>
                                <h6 class="text-dark mb-2">S·∫µn s√†ng nh·∫≠n g·ª£i √Ω!</h6>
                                <p class="text-muted mb-0 small">
                                    Nh·∫•n n√∫t tr√™n ƒë·ªÉ AI ph√¢n t√≠ch v√† ƒë∆∞a ra g·ª£i √Ω th·ª±c ƒë∆°n th√¥ng minh d·ª±a tr√™n nhu c·∫ßu c·ªßa b·∫°n
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u ng√†y t·ª´ server
        let serverCurrentDate = '';

        // H√†m l·∫•y ng√†y hi·ªán t·∫°i t·ª´ server
        async function getServerCurrentDate() {
            try {
                const response = await fetch('/api/current_date');
                const data = await response.json();
                serverCurrentDate = data.current_date;
                return serverCurrentDate;
            } catch (error) {
                console.error('L·ªói l·∫•y ng√†y t·ª´ server:', error);
                // Fallback to client date
                serverCurrentDate = new Date().toISOString().split('T')[0];
                return serverCurrentDate;
            }
        }

        // H√†m c·∫≠p nh·∫≠t navbar
        async function updateNavbar() {
            try {
                const res = await fetch('/api/status');
                const status = await res.json();
                const authLink = document.getElementById('auth-link');
                
                // ·∫®n/hi·ªán menu c·∫ßn ƒëƒÉng nh·∫≠p
                document.querySelectorAll('.login-required').forEach(item => {
                    item.style.display = status.logged_in ? 'block' : 'none';
                });

                if (status.logged_in) {
                    authLink.textContent = 'üö™ ƒêƒÉng Xu·∫•t (' + status.username + ')';
                    authLink.href = '/api/logout';
                    
                    // C·∫£nh b√°o n·∫øu ch∆∞a c√≥ profile
                    if (!status.has_profile && !document.getElementById('profile-alert')) {
                        const alertDiv = document.createElement('div');
                        alertDiv.id = 'profile-alert';
                        alertDiv.className = 'alert alert-warning text-center mt-3 animated-card';
                        alertDiv.innerHTML = `
                            <strong>üìù Ch√†o ${status.username}!</strong> 
                            B·∫°n c·∫ßn <a href="/profile" class="alert-link fw-bold">c·∫≠p nh·∫≠t h·ªì s∆°</a> 
                            ƒë·ªÉ s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng.
                        `;
                        document.querySelector('.container').prepend(alertDiv);
                    }
                } else {
                    authLink.textContent = 'üîê ƒêƒÉng Nh·∫≠p/ƒêƒÉng K√Ω';
                    authLink.href = '/auth';
                }
                return status;
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t navbar:', error);
                return { logged_in: false };
            }
        }

        // Kh·ªüi ch·∫°y khi trang load
        document.addEventListener('DOMContentLoaded', async function() {
            // L·∫•y ng√†y t·ª´ server ƒë·∫ßu ti√™n
            await getServerCurrentDate();
            await updateNavbar();
            initializeApp();
        });

        function initializeApp() {
            // Preview ·∫£nh
            const photoInput = document.getElementById('meal-photo');
            const imagePreview = document.getElementById('image-preview');

            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.style.display = 'none';
                }
            });

            // X·ª≠ l√Ω upload ·∫£nh
            document.getElementById('meal-upload-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!photoInput.files.length) {
                    alert('üì∏ Vui l√≤ng ch·ªçn ·∫£nh m√≥n ƒÉn!');
                    return;
                }
                
                const uploadText = document.getElementById('upload-text');
                const uploadSpinner = document.getElementById('upload-spinner');
                
                uploadText.textContent = 'ƒêang ph√¢n t√≠ch...';
                uploadSpinner.classList.remove('d-none');
                
                try {
                    const formData = new FormData();
                    formData.append('photo', photoInput.files[0]);
                    
                    const response = await fetch('/api/log_meal', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        displayMealRecognition(result.data);
                        await loadFoodLog(); // C·∫≠p nh·∫≠t calories
                    } else {
                        showUploadError('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ ph√¢n t√≠ch ·∫£nh'));
                    }
                } catch (error) {
                    showUploadError('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
                } finally {
                    uploadText.textContent = 'üîç Ph√¢n t√≠ch & Ghi nh·∫≠n';
                    uploadSpinner.classList.add('d-none');
                }
            });

            // X·ª≠ l√Ω g·ª£i √Ω th·ª±c ƒë∆°n
            document.getElementById('suggest-menu-btn').addEventListener('click', async function() {
                const suggestText = document.getElementById('suggest-text');
                const suggestSpinner = document.getElementById('suggest-spinner');
                
                suggestText.textContent = 'AI ƒëang ph√¢n t√≠ch...';
                suggestSpinner.classList.remove('d-none');
                
                try {
                    const response = await fetch('/api/suggest_menu');
                    const result = await response.json();

                    if (response.ok) {
                        if (result.menu_suggestions) {
                            displayMenuSuggestions(result);
                        } else {
                            showError('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c g·ª£i √Ω t·ª´ AI. Vui l√≤ng th·ª≠ l·∫°i.');
                        }
                    } else {
                        showError(result.error || "Kh√¥ng th·ªÉ ƒë∆∞a ra g·ª£i √Ω. Vui l√≤ng ki·ªÉm tra h·ªì s∆°!");
                    }
                } catch (error) {
                    showError('L·ªói k·∫øt n·ªëi: ' + error.message);
                } finally {
                    suggestText.textContent = 'üéØ G·ª£i √Ω Th·ª±c ƒë∆°n ti·∫øp theo';
                    suggestSpinner.classList.add('d-none');
                }
            });

            // Load d·ªØ li·ªáu ban ƒë·∫ßu
            loadFoodLog();
        }

        function showUploadError(message) {
            document.getElementById('meal-recognition-results').innerHTML = `
                <div class="alert alert-danger animated-card">
                    <h6>‚ùå L·ªói ph√¢n t√≠ch ·∫£nh</h6>
                    <p class="mb-0">${message}</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('menu-suggestions').innerHTML = `
                <div class="alert alert-warning animated-card">
                    <h6>‚ö†Ô∏è T·∫°m th·ªùi kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c AI</h6>
                    <p class="mb-2">${message}</p>
                    <small class="text-muted">M·∫πo: Th·ª≠ l·∫°i sau 1-2 ph√∫t ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi internet</small>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadFoodLog()">
                        üîÑ Th·ª≠ l·∫°i
                    </button>
                </div>
            `;
        }

        // H√†m load v√† hi·ªÉn th·ªã calories - ƒê√É S·ª¨A TIMEZONE
        async function loadFoodLog() {
            try {
                const status = await updateNavbar();
                if (!status.logged_in) return;

                const [logRes, profileRes] = await Promise.all([
                    fetch('/api/food_log'),
                    fetch('/api/profile')
                ]);

                const log = logRes.ok ? await logRes.json() : [];
                const profile = profileRes.ok ? await profileRes.json() : null;

                const targetCalories = profile ? profile.target_calories : 0;
                
                // S·ª¨A: D√πng serverCurrentDate thay v√¨ client date
                const today = serverCurrentDate;
                const todayLog = log.filter(item => item.date === today);
                const totalCalories = todayLog.reduce((sum, item) => sum + (parseInt(item.calories) || 0), 0);
                const remainingCalories = targetCalories - totalCalories;

                // C·∫≠p nh·∫≠t UI
                document.getElementById('target-calories').textContent = targetCalories || '--';
                document.getElementById('consumed-calories').textContent = totalCalories;
                document.getElementById('remaining-calories').textContent = remainingCalories || '--';

                // ƒê·ªïi m√†u remaining calories
                const remainingElement = document.getElementById('remaining-calories');
                remainingElement.className = 'fw-bold fs-5 ' + 
                    (remainingCalories < 0 ? 'text-danger' : 
                     remainingCalories > 500 ? 'text-success' : 'text-warning');

            } catch (error) {
                console.error('L·ªói load food log:', error);
            }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ nh·∫≠n di·ªán
        function displayMealRecognition(data) {
            document.getElementById('meal-recognition-results').innerHTML = `
                <div class="fade-in">
                    <div class="alert alert-success border-0">
                        <h6 class="alert-heading">‚úÖ ƒê√£ ghi nh·∫≠n th√†nh c√¥ng!</h6>
                    </div>
                    <div class="card meal-card border-0">
                        <div class="card-body">
                            <h5 class="card-title text-primary">${data.meal_name}</h5>
                            <p class="card-text text-muted">${data.description}</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="badge calorie-badge gradient-warning text-dark">
                                    üî• ${data.calories} kcal
                                </span>
                                <small class="text-muted">
                                    ${new Date().toLocaleTimeString('vi-VN')}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Hi·ªÉn th·ªã g·ª£i √Ω th·ª±c ƒë∆°n
        function displayMenuSuggestions(data) {
            let html = `
                <div class="fade-in">
                    ${data.note ? `<div class="alert alert-info">${data.note}</div>` : ''}
                    <div class="alert gradient-info text-white border-0 mb-3">
                        <h6 class="alert-heading">üí° ${data.advice}</h6>
                    </div>
                    <h6 class="text-primary fw-bold mb-3">üçΩÔ∏è Th·ª±c ƒë∆°n g·ª£i √Ω:</h6>
                    <div class="row g-3">
            `;
            
            data.menu_suggestions.forEach((meal, index) => {
                html += `
                    <div class="col-12">
                        <div class="card suggestion-card border-0">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="card-title text-dark mb-2">
                                            ${index + 1}. ${meal.name}
                                        </h6>
                                        <p class="card-text small text-muted mb-0">
                                            ${meal.nutrition_summary}
                                        </p>
                                    </div>
                                    <span class="badge calorie-badge gradient-primary text-white ms-3">
                                        ${meal.calories} kcal
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            document.getElementById('menu-suggestions').innerHTML = html;
        }
    </script>
</body>
</html>